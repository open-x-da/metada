# WRF 3DVAR Configuration
# Three-dimensional variational data assimilation
# Analyzes observations at a single time (analysis time) without time integration

# Logger configuration
logger:
  app_name: "var3d"
  level: "info"
  color: true
  console: true 
  
# Variational method: 3DVAR (single time analysis)
variational_type: "3DVAR"

# Output configuration
output_base_file: "analysis_3dvar"
format: "nc"
save_trajectory: false

# Optional gradient test for debugging
perform_gradient_test: true

# Minimization configuration
minimization_algorithm: "lbfgs"
max_iterations: 5
tolerance: 1e-6
gradient_tolerance: 1e-8
line_search_enabled: true
preconditioning_enabled: true
lbfgs_memory: 10

# Background error covariance configuration (simplified)
background_covariance:
  size: 717531  # Match actual WRF state size
  variance: 1.0  # Reasonable variance for meteorological variables
  background_covariance_type: "diagonal"
  localization_enabled: false
  localization_radius: 0.0

# Model configuration (WRF model settings)
model:
  # Time control settings
  time_control:
    start_datetime: "2020-01-01T12:00:00Z"
    forecast_length: 1s  # Minimal forecast for 3DVAR - just analysis
    time_step: 30s
    output_history: false
    
  # Physics options
  physics:
    microphysics: true
    radiation: true
    pbl: true
    lsm: true
    
  # Dynamical core options
  dynamics:
    advection_scheme: "WENO"
    diffusion: 0.01

# Geometry configuration (WRF domain)
# WRFGeometry automatically reads all grid information from the NetCDF file
geometry:
  file: "D:/linux/metada/src/backends/wrf/tutorial/wrfinput_d01"

# Background state configuration
background:
  file: "D:/linux/metada/src/backends/wrf/tutorial/wrfinput_d01"
  # Analysis variables for 3DVAR
  variables:
    - U
    - V
    - T #U-component of wind
  
# Analysis time configuration removed for debugging

# Observations configuration
observations:
  types:
    - adpsfc:
        if_use: true
        file: "D:/linux/metada/applications/obs_processing/prepbufr.gdas.2025050700.nr"
        coordinate: "geographic"
        # optional: restrict BUFR subsets interpreted as METAR, leave empty to auto-detect
        data_types: ["ADPSFC"]
        variables:
          - U:
              if_use: true
              error: 1.5
          - V:
              if_use: true
              error: 1.5
          - T:
              if_use: false
              error: 1.0
    - ships:
        if_use: true
        file: "D:/linux/metada/applications/obs_processing/prepbufr.gdas.2025050700.nr"
        coordinate: "geographic"
        data_types: ["SFCSHP"]
        variables:
          - U:
              if_use: true
              error: 2.0
          - V:
              if_use: true
              error: 2.0
          - T:
              if_use: true
              error: 1.0
    - sound:
        if_use: true
        file: "D:/linux/metada/applications/obs_processing/prepbufr.gdas.2025050700.nr"
        coordinate: "geographic"
        data_types: ["ADPUPA"]
        variables:
          - U:
              if_use: true
              error: 3.0
          - V:
              if_use: true
              error: 3.0

# Observation operator configuration (simplified)
obs_operator:
  # Generic external operator configuration for WRFDA
  external_root: "D:/linux/WRF/var/da"  # Path to WRFDA sources
  external_system: "wrfda"               # WRFDA system identifier
  operator_family: ["metar", "sound"]    # Support both surface and upper-air observations
  required_state_vars: [U, V, T, Q, PSFC]
  required_obs_vars: [U, V, T]
  
  # Note: This same configuration structure can be used for other backends:
  # - For GSI: external_root: "D:/linux/GSI", external_system: "gsi"
  # - For DART: external_root: "D:/linux/DART", external_system: "dart"
  # - The framework automatically preserves all backend-specific keys
  # - Switching is done at configuration time, not runtime, for better performance

# Simplified configuration for debugging
# Removed optional sections that may cause configuration parsing issues